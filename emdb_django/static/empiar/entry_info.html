<!--
entry_info.html

Authors:
	Andrii Iudin

Description:
	The main web component for EMPIAR entry pages.

Date:
   20160919

Copyright [2014-17] EMBL - European Bioinformatics Institute
Licensed under the Apache License, Version 2.0 (the
"License"); you may not use this file except in
compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on
an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied. See the License for the
specific language governing permissions and limitations
under the License.

Version history
1.0, 2016/09/19: Initial version.
-->

<dom-module id="entry-info">
	<style>
		.entry_info_panel {
			background-color: #ededed;
			border-radius: 5px;
			padding-left: 4px;
			padding-bottom: 6px;
		}
	</style>

	<template>
		<iron-ajax
		    auto
		    url="{{apiEntryUrl}}{{empiarId}}"
		    handle-as="json"
		    last-response="{{entryAjaxResponse}}"></iron-ajax>

		<template if="{{entryAjaxResponse}}" is="dom-repeat" items="{{_toArray(entryAjaxResponse)}}">
            <div class="row">
                <div class="large-12 columns">
                    <h3>{{item.value.title}}</h3>
                </div>
            </div>

            <div class="row">
                <div class="large-8 columns">
                    <template is="dom-if" if="{{_citationAvailable(item.value.citation)}}">
                        <div class="row">
                            <div class="data-label large-4 columns">Publication:</div>
                            <div class="large-8 columns">
                                <div>{{item.value.citation.0.title}}</div>

                                <div>
                                    <template is="dom-repeat" items="{{item.value.citation.0.authors}}" as="author">
                                        <template is="dom-if" if="{{author.author_orcid}}" on-dom-change="_handleTooltip">
                                            <a href="http://europepmc.org/search?query=AUTHORID:%22{{author.author_orcid}}%22&sortby=Date" target = "_blank">{{_formatAuthorName(author.name)}}</a>&nbsp<a class="image no-underline" title="ORCID - Connecting Research and Researchers" href="https://orcid.org/{{author.author_orcid}}" target = "_blank"><span class="copyable_tooltip" title="ORCID iD: {{author.author_orcid}}"><img src="//www.ebi.ac.uk/web_guidelines/images/logos/orcid/orcid_16x16.png"></span></a></template><template is="dom-if" if="{{!author.author_orcid}}">
                                            <span class="empiarAuthorList">{{author.name}}</span></template><template is="dom-if" if="{{_notLastElement(item.value.citation.0.authors.length, index)}}">, </template>
                                    </template>
                                </div>

                                <div>
                                    <i><template is="dom-if" if="{{item.value.citation.0.journal_abbreviation}}">{{item.value.citation.0.journal_abbreviation}}</template><template is="dom-if" if="{{!item.value.citation.0.journal_abbreviation}}">{{item.value.citation.0.journal}}</template></i>
                                    <template is="dom-if" if="{{item.value.citation.0.volume}}">
                                        <b>{{item.value.citation.0.volume}}</b>
                                    </template>
                                    <template is="dom-if" if="{{item.value.citation.0.first_page}}">{{item.value.citation.0.first_page}}</template><template is="dom-if" if="{{item.value.citation.0.last_page}}">-{{item.value.citation.0.last_page}}</template><template is="dom-if" if="{{item.value.citation.0.year}}"> ({{item.value.citation.0.year}})</template>
                                    <template is="dom-if" if="{{item.value.citation.0.pubmedid}}">
                                        <div>
                                            PMID:
                                            <a href="http://europepmc.org/abstract/MED/{{item.value.citation.0.pubmedid}}">{{item.value.citation.0.pubmedid}}</a>
                                        </div>
                                    </template>
                                    <template is="dom-if" if="{{item.value.citation.0.doi}}">
                                        <div>
                                            DOI:
                                            <a href="http://doi.org/{{item.value.citation.0.doi}}">{{_formatDoi(item.value.citation.0.doi)}}</a>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <template is="dom-if" if="{{!_citationAvailable(item.value.citation)}}">
                        <div class="row">
                            <div class="data-label large-12 columns">No publication information available</div>
                            <div class="data-label large-4 columns">Author{{_pluralize(item.value.authors)}}:</div>
                            <div class="large-8 columns">
                                <template is="dom-repeat" items="{{item.value.authors}}" as="author">
                                    <template is="dom-if" if="{{author.author.author_orcid}}" on-dom-change="_handleTooltip">
                                        <a href="http://europepmc.org/search?query=AUTHORID:%22{{author.author.author_orcid}}%22&sortby=Date" target = "_blank">{{author.author.name}}</a> <a class="image no-underline" title="ORCID - Connecting Research and Researchers" href="https://orcid.org/{{author.author.author_orcid}}" target = "_blank"><span class="copyable_tooltip" title="ORCID iD: {{author.author.author_orcid}}"><img src="//www.ebi.ac.uk/web_guidelines/images/logos/orcid/orcid_16x16.png"></span></a></template><template is="dom-if" if="{{!author.author.author_orcid}}">
                                        <span class="empiarAuthorList">{{author.author.name}}</span></template><template is="dom-if" if="{{_notLastElement(item.value.authors.length, index)}}">, </template>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template is="dom-if" if="{{item.value.related_pdb_entries}}">
                        <div class="row">
                            <div class="data-label large-4 columns">Related PDB entr<template is="dom-if" if="{{item.value.related_pdb_entries.1}}">ies</template><template is="dom-if" if="{{!item.value.related_pdb_entries.1}}">y</template>:</div>
                            <div class="large-8 columns">
                                <template is="dom-repeat" items="{{item.value.related_pdb_entries}}" as="related_pdb_entry">
                                    <a href="http://pdbe.org/{{related_pdb_entry}}">{{related_pdb_entry}}</a><template is="dom-if" if="{{_notLastElement(item.value.related_pdb_entries.length, index)}}">, </template>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template is="dom-if" if="{{item.value.cross_references.0}}">
                        <div class="row">
                            <div class="data-label large-4 columns">Related EMDB entr<template is="dom-if" if="{{item.value.cross_references.1}}">ies</template><template is="dom-if" if="{{!item.value.cross_references.1}}">y</template>:</div>
                            <div class="large-8 columns">
                                <template is="dom-repeat" items="{{item.value.cross_references}}" as="cross_reference">
                                    <a href="http://pdbe.org/{{cross_reference.name}}">{{cross_reference.name}}</a><template is="dom-if" if="{{_notLastElement(item.value.cross_references.length, index)}}">, </template>
                                </template>
                            </div>
                        </div>
                    </template>

                    <div class="row">
                        <div class="data-label large-4 columns">Deposited:</div>
                        <div class="large-8 columns">{{item.value.deposition_date}}</div>
                    </div>

                    <div class="row">
                        <template is="dom-if" if="{{_variablesAreEqual(item.value.status, 'REL')}}">
                            <div class="data-label large-4 columns"">Released:</div>
                            <div class="large-8 columns">{{item.value.release_date}}</div>
                        </template>
                        <template is="dom-if" if="{{!_variablesAreEqual(item.value.status, 'REL')}}">
                            <div class="data-label large-4 columns">Obsoleted:</div>
                            <div class="large-8 columns">{{item.value.obsolete_date}}</div>
                        </template>
                    </div>

                    <div class="row">
                        <div class="data-label large-4 columns">Last modified:</div>
                        <div class="large-8 columns">{{item.value.update_date}}</div>
                    </div>

                    <div class="row">
                        <div class="data-label large-4 columns">Dataset size:</div>
                        <div class="large-8 columns">{{item.value.dataset_size}}</div>
                    </div>

                    <div class="row">
                        <div class="data-label large-4 columns">Dataset DOI:</div>
                        <div class="large-8 columns"> <a href="http://dx.doi.org/10.6019/EMPIAR-{{empiarId}}">10.6019/EMPIAR-{{empiarId}}</a></div>
                    </div>


                    <template is="dom-if" if="{{_arrayIsNotEmpty(item.value.version_history)}}">
                        <div class="row">
                            <div class="data-label large-4 columns">Version history:</div>
                            <div class="large-8 columns">
                                <template is="dom-repeat" items="{{item.value.version_history}}" as="version_history">
                                    <div class="row">
                                        <div class="large-2 columns">{{version_history.version_number}}</div>
                                        <div class="large-4 columns">{{version_history.date}}</div>
                                        <div class="large-6 columns">{{version_history.details}}</div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <template is="dom-if" if="{{item.value.volume_slicer_links}}">
                        <div class="row">
                            <br/>
                            <div class="data-label large-4 columns">View data in volume slicer:</div>
                            <div class="large-8 columns">
                                <template is="dom-repeat" items="{{item.value.volume_slicer_links}}" as="volume_slicer_link">
                                    <a href="{{volume_slicer_link}}">{{_vs_filename(volume_slicer_link)}}</a>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>


                <div class="large-4 columns">
                    <div>
                        <div class="data-label">Contains:</div>
                        <div class="large-12 columns">
                            <template is="dom-repeat" items="{{_imagesetCategories(item.value.imagesets)}}" as="category">
                                <template is="dom-if" if="{{_variableContains(category, 'micrographs')}}">
                                    <img src="{{staticImg}}/micrographs.png" class="micro_icon" alt=""/>    micrographs
                                </template>
                                <template is="dom-if" if="{{!_variableContains(category, 'micrographs')}}">
                                    <template is="dom-if" if="{{_variableContains(category, 'picked particles')}}">
                                        <img src="{{staticImg}}/picked%20particles.png" class="micro_icon" alt=""/>    picked particles
                                    </template>
                                    <template is="dom-if" if="{{!_variableContains(category, 'picked particles')}}">
                                        <template is="dom-if" if="{{_variableContains(category, 'tilt series')}}">
                                            <img src="{{staticImg}}/micrographs.png" class="micro_icon" alt=""/>    tilt series
                                        </template>
                                    </template>
                                </template>
                                <br/>
                            </template>
                        </div>
                    </div>
                </div>

                <template is="dom-if" if="{{!_variablesAreEqual(item.value.status, 'OBSOLETE')}}">
                    <div class="small-5 medium-6 large-4 columns">
                        <div class="image-x empiarIntroImage" typeof="ImageObject" vocab="http://schema.org/" property="image">
                            <meta content="1" property="representativeOfPage">
                            <img src="{{empiarIconDir}}/{{empiarId}}-l.gif" onerror="this.src='{{staticRelPath}}/images/noimage.png'" alt="Image not available"/>
                        </div>
                    </div>
                </template>

            </div>

				<div class="row">
					<!-- Aspera plugin container has to be visible at all times for Aspera to work properly -->
					<template is="dom-repeat" items="{{item.value.imagesets}}">
						<div id="pluginContainer{{empiarId}}_imgs_{{index}}"></div>
					</template>
					<div id="pluginContainer{{empiarId}}"></div>
					
					
					<section class="large-12 columns padding-top-medium">
						<div id="noAspera{{empiarId}}" class="noAspera{{empiarId}}"></div>	
						<h4 class="slideToggle icon icon-functional" data-icon="w">Image set{{_pluralize(item.value.imagesets)}}</h4>
                        <div class="large-12 columns">
                            <template is="dom-if" if="{{!_variablesAreEqual(item.value.status, 'OBSOLETE')}}">
                                <template is="dom-repeat" items="{{item.value.imagesets}}" as="imageset" on-dom-change="_handleJsTreeImageset">

                                    <section class="large-12 columns padding-top-small padding-bottom-medium">

                                        <h5 class="slideToggle icon icon-functional padding-top-medium" data-icon="w">{{imageset.name}}</h5>

                                        <div class="large-12 columns">
                                            <div class="row">
                                                <span class="data-label large-4 columns">Category:</span>
                                                <span class="large-8 columns">{{imageset.category}}</span>
                                            </div>

                                            <div class="row">
                                                <span class="data-label large-4 columns">Image format:</span>
                                                <span class="large-8 columns">{{imageset.header_format}}</span>
                                            </div>

                                            <div class="row">
                                                <span class="data-label large-4 columns">No. of images or tilt series:</span>
                                                <span class="large-8 columns">{{imageset.num_images_or_tilt_series}}</span>
                                            </div>

                                            <template is="dom-if" if="{{!_variableContains(imageset.category, 'single frame')}}">
                                                <template is="dom-if" if="{{!_variableContains(imageset.category, 'tilt series')}}">
                                                    <div class="row">
                                                        <span class="data-label large-4 columns">Frames per image:</span>
                                                        <span class="large-8 columns">{{imageset.frames_per_image}}</span>
                                                    </div>
                                                </template>
                                            </template>

                                            <div class="row">
                                                <span class="data-label large-4 columns">Image size:</span>
                                                <span class="large-8 columns">({{imageset.image_width}}, {{imageset.image_height}})</span>
                                            </div>

                                            <div class="row">
                                                <span class="data-label large-4 columns">Pixel type:</span>
                                                <span class="large-8 columns">{{imageset.voxel_type}}</span>
                                            </div>

                                            <template is="dom-if" if="{{!_variablesAreEqual(imageset.pixel_width, null)}}">
                                                <template is="dom-if" if="{{!_variablesAreEqual(imageset.pixel_height, null)}}">
                                                    <div class="row">
                                                        <span class="data-label large-4 columns">Pixel spacing:</span>
                                                        <span class="large-8 columns">({{imageset.pixel_width}} &#8491;, {{imageset.pixel_height}} &#8491;)</span>
                                                    </div>
                                                </template>
                                            </template>

                                            <template is="dom-if" if="{{ scipionViewerUrl }}">
                                                <template is="dom-if" if="{{ imageset.scipion_workflow }}">
                                                    <div class="row">
                                                        <span class="data-label large-4 columns">SCIPION workflow:</span>
                                                        <span class="large-8 columns"><a target="_blank" href="{{ scipionViewerUrl }}{{ imageset.scipion_workflow }}">View</a></span>
                                                    </div>
                                                </template>
                                            </template>

                                            <template is="dom-if" if="{{imageset.details}}" on-dom-change="_handleDetails">
                                                <div class="row">
                                                    <span class="data-label large-4 columns">Details:</span>
                                                    <span class="large-8 columns comment">{{_nl2br(imageset.details)}}</span>
                                                </div>
                                            </template>

                                            <div class="row">
                                                <div id="transferDiv{{empiarId}}_imgs_{{index}}" class="transferDiv"></div>
                                            </div>
                                            <div class="row">
                                                <div id="dlImageSet{{empiarId}}_imgs_{{index}}"></div>
                                            </div>
                                            <div class="row">
                                                <div id="jstree{{empiarId}}_imgs_{{index}}"></div>
                                            </div>
                                        </div>
                                    </section>

                                </template>
                            </template>

                            <template is="dom-if" if="{{_variablesAreEqual(item.value.status, 'OBSOLETE')}}">
                                <template is="dom-repeat" items="{{item.value.imagesets}}" as="imageset">
                                    <section class="large-12 columns">

                                    <h5 class="slideToggle icon icon-functional" data-icon="w">{{imageset.name}}</h5>

                                    <div class="large-12 columns">
                                        <div class="row">
                                            <span class="data-label large-4 columns">Category:</span>
                                            <span class="large-8 columns">{{imageset.category}}</span>
                                        </div>

                                        <div class="row">
                                            <span class="data-label large-4 columns">Image format:</span>
                                            <span class="large-8 columns">{{imageset.header_format}}</span>
                                        </div>

                                        <div class="row">
                                            <span class="data-label large-4 columns">No. of images or tilt series:</span>
                                            <span class="large-8 columns">{{imageset.num_images_or_tilt_series}}</span>
                                        </div>

                                        <template is="dom-if" if="{{!_variableContains(imageset.category, 'single frame')}}">
                                            <template is="dom-if" if="{{!_variableContains(imageset.category, 'tilt series')}}">
                                                <div class="large-12 columns">
                                                    <span class="data-label large-4 columns">Frames per image:</span>
                                                    <span class="large-8 columns">{{imageset.frames_per_image}}</span>
                                                </div>
                                            </template>
                                        </template>

                                        <div class="row">
                                            <span class="data-label large-4 columns">Image size:</span>
                                            <span class="large-8 columns">({{imageset.image_width}}, {{imageset.image_height}})</span>
                                        </div>

                                        <div class="row">
                                            <span class="data-label large-4 columns">Pixel type:</span>
                                            <span class="large-8 columns">{{imageset.voxel_type}}</span>
                                        </div>

                                        <template is="dom-if" if="{{!_variablesAreEqual(imageset.pixel_width, null)}}">
                                            <template is="dom-if" if="{{!_variablesAreEqual(imageset.pixel_height, null)}}">
                                                <div class="row">
                                                    <span class="data-label large-4 columns">Pixel spacing:</span>
                                                    <span class="large-8 columns">({{imageset.pixel_width}} &#8491;, {{imageset.pixel_height}} &#8491;)</span>
                                                </div>
                                            </template>
                                        </template>

                                        <template is="dom-if" if="{{imageset.details}}" on-dom-change="_handleDetails">
                                            <div class="row">
                                                <span class="data-label large-4 columns">Details:</span>
                                                <span class="large-8 columns comment">{{_nl2br(imageset.details)}}</span>
                                            </div>
                                        </template>
                                    </div>
                                    </section>
                                </template>
                            </template>
                        </div>

						<div id="empiarLoaderGif">
							<div class="empiarLoaderInner">
								<img src="{{loadingCircleImg}}" alt="Loading..."></img>
							</div>
						</div>
						<div id="empiarChooseDl">
							<div id="empiarChooseDlInner">
							<span class="empiarCloser">X</span>
							Available download options:
							</div>
						</div>
						<div id="empiarLoader">
							<div class="empiarLoaderInner">
								<div id="circularG">
									<div id="circularG_1" class="circularG">
									</div>
									<div id="circularG_2" class="circularG">
									</div>
									<div id="circularG_3" class="circularG">
									</div>
									<div id="circularG_4" class="circularG">
									</div>
									<div id="circularG_5" class="circularG">
									</div>
									<div id="circularG_6" class="circularG">
									</div>
									<div id="circularG_7" class="circularG">
									</div>
									<div id="circularG_8" class="circularG">
									</div>
								</div>
							</div>
						</div>
					</section>
					
					<template is="dom-if" if="{{!_variablesAreEqual(item.value.status, 'OBSOLETE')}}" on-dom-change="_handleJsTree">
						<div id="empiarBrowseAllFilesDiv" class="large-12 columns padding-top-xlarge">
							<h4>Browse All Files</h4>
							<div class="large-12 columns">
								<div id="transferDiv{{empiarId}}" class="transferDiv"></div>
							</div>
                            <div class="large-12 columns">
								<div id="btnid{{empiarId}}"></div>
							</div>
							<div class="large-12 columns">
								<div id="jstree_json{{empiarId}}"></div>	
							</div>
						</div>
					</template>
					
					<div class="large-12 columns padding-top-xlarge">
						<div id="browseFtp"></div>
					</div>

				</div>
        </template>

        <template if="{{!entryAjaxResponse}}" is="dom-if">
        	<h2>
				<span property="title"><a href="">The requested entry does not exist</a></span>
			</h2>
			<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
			<div class="large-12 columns reset_100"></div>
			<div class="large-12 columns reset_100"></div>
        </template>


    <!-- Root element of EMPIAR thumbnail display. Must have class empthumb. -->
    <div class="empthumb" tabindex="-1" role="dialog" aria-hidden="true">

        <!-- Background. It's a separate element as animating opacity is faster than rgba(). -->
        <div class="empthumb__bg"></div>

        <!-- Slide wrapper with overflow:hidden. -->
        <div class="empthumb__scroll-wrap">

            <!-- Container that holds the slide. -->
            <div class="empthumb__container">
                <div class="empthumb__item"></div>
            </div>

            <!-- Interface on top of sliding area. -->
            <div class="empthumb__ui empthumb__ui--hidden">

                <div class="empthumb__top-bar">
                    <button class="empthumb__button empthumb__button--close" title="Close (Esc)"></button>

                    <button class="empthumb__button empthumb__button--share" title="Share"></button>
                </div>

                <div class="empthumb__share-modal--hidden empthumb__single-tap style-scope entry-info empthumb__share-modal--fade-in">
                    <div class="empthumb__share-tooltip style-scope entry-info">
                        <a target="_blank" class="empthumb__share--facebook">Share on Facebook</a>
                        <a target="_blank" class="empthumb__share--twitter">Tweet</a>
                        <a target="_blank" class="empthumb__share--pinterest">Pin it</a>
                        <a target="_blank" class="empthumb__share--download" download>Download image</a>
                    </div>
                </div>

                <button class="empthumb__button empthumb__button--arrow--left" title="Previous (arrow left)">
                </button>

                <button class="empthumb__button empthumb__button--arrow--right" title="Next (arrow right)">
                </button>

                <div class="empthumb__caption">
                    <div class="empthumb__caption__center"></div>
                </div>

            </div>

        </div>

    </div>



    </template>


	<script>
	Object.size = function(obj) {
	    var size = 0, key;
	    for (key in obj) {
	        if (obj.hasOwnProperty(key)) size++;
	    }
	    return size;
	};

	function displayThumb(treeDiv, thumbnailsCheckUrl, staticRelPath, csrfToken) {
		// On hover over a jsTree node, if the file thumbnail represented by the node exists, then
		// change the cursor to an eye
		$(treeDiv).on('hover_node.jstree', function(e, data) {
			var hoveredNode = data.node;
			var filepath = $(treeDiv).jstree("get_path", hoveredNode, '/');
			var elementToChange = document.getElementsByClassName('jstree-anchor jstree-hovered')[0];
			if ( !(elementToChange.hasAttribute("eye")) ) {
				if ( ($(hoveredNode)[0].original.type == "file") && isImageFile(filepath) ) {
					$.ajax({
			            type: "post",
			            cache: true,
			            url: thumbnailsCheckUrl,
			            data: { 'path': filepath, 'node_id': hoveredNode.id, 'csrfmiddlewaretoken': csrfToken },
			            dataType : 'json',
			            success: function(dataPy){
							if (dataPy.cur_node) {
								if ( typeof elementToChange != 'undefined' ) {
									elementToChange.style.cursor = "url('" + staticRelPath + "/empiar/img/view.cur'), auto";
								}
							}
			            },
			        });
				}
				elementToChange.setAttribute("eye", true);
			};
		});
	}
	
	
    function pathJoin(parts, sep){
	   var separator = sep || '/';
	   var replace   = new RegExp(separator+'{1,}', 'g');
	   return parts.join(separator).replace(replace, separator);
	}
	
    function downloadButtonFtpClick(e) {
    	if (e.data.status != 'OBSOLETE')
        	window.open(pathJoin([e.data.publicArchiveFtpUrl, e.data.empiarId]));
        else
        	window.open(pathJoin([e.data.obsoleteArchiveFtpUrl, e.data.empiarId]));
	};
	
	Polymer({
		is: "entry-info",
		properties: {
			apiEntryUrl: String,
			entryUrl: String,
			empiarId: String,
			staticImg: String,
			empiarIconDir: String,
			staticRelPath: String,
			loadingCircleImg: String,
			thumbnailsCheckUrl: String,
			thumbnailsRenderUrl: String,
			nextPageDown: String,
			nextPageUp: String,
			publicArchiveFtpUrl: String,
			obsoleteArchiveFtpUrl: String,
			csrfToken: String,
			omeroUrl: String,
			asperaTokenUrl: String,
            scipionViewerUrl: String
        },
		_arrayIsNotEmpty: function(a) {
			if ( a.length > 0 )
        		{ return true; }
        	else
        		{ return false; }
        },
        _toArray: function(obj) {
        	if (obj !== 'undefined' && obj !==null)
	            return Object.keys(obj).map(function(key) {
	                return {
	                    name: key,
	                    value: obj[key]
	                };
	            });
	        else
	        	return null;
        },
        _pluralize: function(obj, suffix_single, suffix_plural) {
        	if ( obj.length > 1 )
        		{ return typeof suffix_plural !== 'undefined' ? suffix_plural : 's'; }
        	else
        		{ return typeof suffix_single !== 'undefined' ? suffix_single : ''; }
        },
        _handleTooltip: function() {
        	$('.copyable_tooltip').tooltip({
		        open: function(){
		            // Make sure all other tooltips are closed when opening a new one
		        $('.copyable_tooltip').not(this).tooltip('close');
		        }
		    }).on('mouseleave', function(e){
		        var that = this;

		        // Close the tooltip later
		        mouseLeaveTimer = setTimeout(function(){
		        	$(that).tooltip('close');
		        }, 300);

		        // Prevent tooltip widget to close the tooltip now
		        e.stopImmediatePropagation();
		    });

		    $(document).on('mouseenter', '.ui-tooltip', function(e){
		        // Cancel tooltip closing on hover
		        clearTimeout(mouseLeaveTimer);
		    });

		    $(document).on('mouseleave', '.ui-tooltip', function(){
		        // Make sure tooltip is closed when the mouse is gone
		        $('.copyable_tooltip').tooltip('close');
		    });
        },
        _citationAvailable: function(citation) {
        	if ( Object.size(citation[0]) > 1 ) {

        		if ( citation[0].authors.length > 0) {
        			if ( citation[0].j_or_nj_citation ) {
        				if ( citation[0].journal != null && citation[0].journal != 'N/A' ) {
        					return true;
        				}
        			} else {
        				if ( citation[0].publisher != null && citation[0].publisher != 'N/A' ) {
        					return true;
        				}
        			}
        		}
        	}
        	return false;
        },
        _handleDetails: function() {
    	    $(".comment").collapser({
			    mode: 'lines',
			    truncate: 3,
			    dynamic: true,
			    escapeHtml: false
			});
        },
        _handleJsTreeImageset: function() {
        	var entryUrl = this.entryUrl + this.empiarId;
        	var trfcImageSets = new Array();
			// Add FileControllers for Aspera for jsTree elements that represent separate image sets
			// and add those jsTree elements
			var imagesets = this.entryAjaxResponse['EMPIAR-'+this.empiarId].imagesets;

			for (i=0; i<imagesets.length; ++i) {
				trfcImageSets[i] = new EMPIAR.FileControl({ sessionId: 'empiar-download'+this.empiarId+'_imgs_'+i,
					transferContainer: 'transferDiv'+this.empiarId+'_imgs_'+i,
					messageContainer: 'noAspera'+this.empiarId,
					id: this.empiarId+'_imgs_'+i 
				});
				browserTree({
				    dirStruct: 'full',
                    asperaOnly: false,
                    entryName: this.empiarId,
                    treeDiv: '#jstree'+this.empiarId+'_imgs_'+i,
                    buttonId: 'dlImageSet'+this.empiarId+'_imgs_'+i,
                    sourcePath: 'archive/',
                    treeFileController: trfcImageSets[i],
                    entryUrl: entryUrl,
                    imageSetId: i,
                    noCheckbox: null,
                    csrfToken: this.csrfToken,
                    asperaTokenUrl: this.asperaTokenUrl
                });
				displayThumb('#jstree'+this.empiarId+'_imgs_'+i, this.thumbnailsCheckUrl, this.staticRelPath, this.csrfToken);
				handleNodeClick('#jstree'+this.empiarId+'_imgs_'+i, this.thumbnailsCheckUrl, this.thumbnailsRenderUrl, this.loadingCircleImg, this.nextPageDown, this.nextPageUp, this.csrfToken, this.omeroUrl);
			}

            // Activate slide-toggle
            try {
                jQuery(".slideToggle").unbind("click");
                jQuery('.slideToggle[data-icon="u"]').next().hide();
                jQuery('.slideToggle[data-icon="9"]').next().hide();
                jQuery('.slideToggle[data-icon="u"][data-slideabove="true"]').prev().hide();
                jQuery('.slideToggle[data-icon="9"][data-slideabove="true"]').prev().hide();

                jQuery(".slideToggle").click(function() {
                    if (jQuery(this).attr("data-icon") === "u" || jQuery(this).attr("data-icon") === "w") {
                        if (jQuery(this).attr("data-icon") === "u") {
                            jQuery(this).attr("data-icon", "w")
                        } else {
                            jQuery(this).attr("data-icon", "u")
                        }
                    }
                    if (jQuery(this).attr("data-icon") === "8" || jQuery(this).attr("data-icon") === "9") {
                        if (jQuery(this).attr("data-icon") === "8") {
                            jQuery(this).attr("data-icon", "9")
                        } else {
                            jQuery(this).attr("data-icon", "8")
                        }
                    }
                    if (jQuery(this).attr("data-slideabove") === "false" || jQuery(this).attr("data-slideabove") === undefined) {
                        var b = jQuery(this).parent();
                        jQuery(this).next().slideToggle(200, function() {
                            if (jQuery(this).css("display") === "none") {
                                jQuery(this).siblings(".nano-pane").hide()
                            } else {
                                jQuery(this).siblings(".nano-pane").show()
                            }
                        })
                    } else {
                        jQuery(this).prev().slideToggle(200)
                    }
                })
            } catch (a) {}
        },
        _handleJsTree: function() {
        	if (this.entryAjaxResponse['EMPIAR-'+this.empiarId].status != 'OBSOLETE') {
				var entryUrl = this.entryUrl + this.empiarId;
				
				// Add a FileController for Aspera for the jsTree element that represents the whole directory
				var trfc = new EMPIAR.FileControl({ sessionId: 'empiar-download{{empiarId}}',
						transferContainer: 'transferDiv'+this.empiarId,
						messageContainer: 'noAspera'+this.empiarId,
						id: this.empiarId
					});

				// Add the jsTree element that represents the whole directory
				browserTree({
				    dirStruct: 'full',
                    asperaOnly: false,
                    entryName: this.empiarId,
                    treeDiv: '#jstree_json'+this.empiarId,
                    buttonId: 'btnid'+this.empiarId,
                    sourcePath: 'archive/',
                    treeFileController: trfc,
                    entryUrl: entryUrl,
                    imageSetId: null,
                    noCheckbox: null,
                    csrfToken: this.csrfToken,
                    asperaTokenUrl: this.asperaTokenUrl
                });
				displayThumb('#jstree_json'+this.empiarId, this.thumbnailsCheckUrl, this.staticRelPath, this.csrfToken);
				handleNodeClick('#jstree_json'+this.empiarId, this.thumbnailsCheckUrl, this.thumbnailsRenderUrl,
                    this.loadingCircleImg, this.nextPageDown, this.nextPageUp, this.csrfToken, this.omeroUrl);
			}

			// Add a button to browse the FTP directory of the entry
			var downloadButtonFtp = $('<button/>',
				    {
						id: 'browseFtpButtonId',
				        label: 'Browse Ftp',
				        text: 'Browse Ftp',
				    });
			downloadButtonFtp.addClass("empiarDownloadButton icon icon-functional");
		    $("#browseFtp").append(downloadButtonFtp);
			downloadButtonFtp.on("click", {status: this.entryAjaxResponse['EMPIAR-'+this.empiarId].status,
										   publicArchiveFtpUrl: this.publicArchiveFtpUrl,
										   obsoleteArchiveFtpUrl: this.obsoleteArchiveFtpUrl,
										   empiarId: this.empiarId}, downloadButtonFtpClick);
			
			// Add event to close the menu of download options upon clicking anywhere on the part
			// of the screen covered by the #empiarChooseDl shadowbox
			$("#empiarChooseDl").on("click", function(e) {
		       	$('#empiarChooseDlInner').children("div").remove()
		       	$('#empiarChooseDl').hide();
			});
        },
        _formatDoi: function(doi) {
        		return doi.replace('doi:','');
        },
        _formatAuthorName: function(authorName) {
        		return authorName.replace(/ /g, "\u00a0");
        },
        _variableContains: function (a, b) {
        	if ( a.indexOf(b) >= 0 )
        		{ return true; }
        	else
        		{ return false; }
        },
        _variablesAreEqual: function (a, b) {
        	if (a == b)
        		{ return true; }
        	else
        		{ return false; }
        },
        _nl2br: function(str){
			return str.replace(new RegExp('\n', 'g'), '<br/>');
		},
        _vs_filename: function (vs_url) {
        	var parts = vs_url.split('/empiar_'+this.empiarId+'_');
        	if ( parts.length > 1 )
        		return parts[1] + '.mrc';
        	return 'name unavailable';
        },
		ready: function () {
		},
		_notLastElement: function(length, index){
			if( (parseInt(length) - 1) != parseInt(index))
				{ return true; } 
			else 
				{ return false; }
		},
		_imagesetCategories: function(imagesets) {
			var result = [];
			for (i=0; i<imagesets.length; ++i) {
				var full_imageset_category = imagesets[i].category;
				var short_imageset_category = '';
				if (full_imageset_category.indexOf('micrographs') > -1)
					short_imageset_category = 'micrographs';
				else if (full_imageset_category.indexOf('picked particles') > -1)
					short_imageset_category = 'picked particles';
				else if (full_imageset_category.indexOf('tilt series') > -1)
					short_imageset_category = 'tilt series';
				
				if ( (short_imageset_category!='') && ($.inArray(short_imageset_category, result) == -1) ) {
					result.push(short_imageset_category);
				}
			}
			return result;
		},
	});
	
	</script>
</dom-module>
